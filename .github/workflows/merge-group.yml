# Jobs that run on merge_group, meaning they must pass before changes land. They also run on pull_request.

on:
    pull_request:
    merge_group:

concurrency:
    group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

jobs:
    lint:
        name: Lint (Biome)
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
            - uses: jdx/mise-action@v3

            - run: npm ci

            - run: npx @tanstack/router-cli generate --routesDirectory ./src/routes --generatedRouteTree ./src/routeTree.gen.ts

            - run: npm run ci:lint

    format:
        name: Format (Biome)
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v6
            - uses: jdx/mise-action@v3

            - run: npm ci

            - run: npm run ci:format

    typecheck:
        name: Type Check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
            - uses: jdx/mise-action@v3

            - name: Install dependencies
              run: npm ci

            - name: Generate route files
              run: npx @tanstack/router-cli generate --routesDirectory ./src/routes --generatedRouteTree ./src/routeTree.gen.ts

            - name: Type Check
              run: npm run ci:typecheck

    test:
        name: Test
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - uses: actions/checkout@v6
            - uses: jdx/mise-action@v3

            - run: npm ci

            - run: npm run ci:test

    coverage:
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - uses: actions/checkout@v6
            - uses: jdx/mise-action@v3

            - run: npm ci

            - run: npm run test:coverage

            - name: Upload coverage report
              uses: actions/upload-artifact@v6
              with:
                  name: coverage-report
                  path: coverage/
                  retention-days: 14

    build:
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - uses: actions/checkout@v6
            - uses: jdx/mise-action@v3

            - run: npm ci

            - name: Generate route files
              run: npx @tanstack/router-cli generate --routesDirectory ./src/routes --generatedRouteTree ./src/routeTree.gen.ts

            - run: npm run build

            - name: Upload build artifacts
              if: success()
              uses: actions/upload-artifact@v6
              with:
                  name: dist
                  path: dist/
                  retention-days: 1

    build-types:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
            - uses: jdx/mise-action@v3

            - run: npm ci

            - name: Generate route files
              run: npx @tanstack/router-cli generate --routesDirectory ./src/routes --generatedRouteTree ./src/routeTree.gen.ts

            - run: npm run build:types

    pre-commit:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
            - uses: actions/setup-python@v6
              with:
                  python-version: "3.x"
            - uses: jdx/mise-action@v3
            - run: npm ci
            - uses: pre-commit/action@v3.0.1

    all-checks:
        name: All checks
        if: ${{ !cancelled() }}
        needs: [lint, format, typecheck, test, coverage, build, build-types, pre-commit]
        runs-on: ubuntu-latest
        steps:
            - uses: re-actors/alls-green@release/v1
              with:
                  jobs: ${{ toJSON(needs) }}
